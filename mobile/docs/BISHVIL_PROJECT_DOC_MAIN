# Bishvil ‚Äì Project Documentation (Reshaped)

*Last reshaped: 2026-01-02*

This document consolidates and restructures the project documentation into four clear layers:

1. **Product Specification** ‚Äì what the product is and is not
2. **Architecture & Decisions** ‚Äì stable, long‚Äëterm choices
3. **Current Status** ‚Äì factual snapshot of where the project stands
4. **Execution Plan (TODO)** ‚Äì forward‚Äëlooking, actionable work

The content below was **moved and deduplicated** from the original documents to ensure each section has a single responsibility.

---

## 1. Product Specification (Stable)

### Purpose

Bishvil is an **Android‚Äëfirst mobile app** for organizing and joining cycling rides in Israel (MTB / Gravel / Road), optimized for *operational compatibility* (pace, skill, timing) rather than social networking.

### Core Principles

* Fast ride discovery and joining
* Low friction, minimal ceremony
* Privacy‚Äëfirst (no phone exposure)
* Hebrew‚Äëfirst with full RTL/LTR support

### Target Platform

* Android first (APK distribution)
* iOS later (no architectural blockers)

### MVP Scope

* Ride creation and discovery
* Join / approval flows
* Profiles (lightweight)
* Map‚Äëbased location selection
* Bilingual UI (Hebrew / English)

### Explicitly Out of Scope (MVP)

* GPS ride tracking
* Media uploads
* Social feeds, likes, ratings
* Internal moderation tools

### KPIs (Pilot)

* Time to first joined ride
* % of rides that actually happen
* Repeat rides with the same participants

---

## 2. Architecture & Decisions (Long‚ÄëTerm)

### Mobile Stack

* React Native + Expo (TypeScript)
* react-native-paper (Material Design 3)
* Design‚Äësystem driven (Strava‚Äëlike feel)

### Backend

* Supabase

  * Auth: Phone OTP (Twilio Verify)
  * PostgreSQL + RLS
  * Realtime (future chat / notifications)

### Authentication

* Phone OTP only (Israeli norm, high completion)
* No email auth in MVP
* Sessions persist across restarts

### Profiles

* `profiles` table separate from `auth.users`
* Auto‚Äëcreated via DB trigger
* Phone number not duplicated in app tables

### Privacy Decisions

* Phone numbers never exposed to other users
* Display name is the only visible identity
* Future contact via in‚Äëapp or WhatsApp link only

### Maps

* Mapbox GL (native build)
* Israel Hiking Map tiles
* Text + map pin required
* No reverse geocoding by design

### Deferred Backend (Reserved)

* FastAPI (Python) for:

  * moderation
  * trust scoring
  * scheduled jobs
  * external integrations

---

## 3. Current Project Status (Snapshot)

**Stage:** Pilot‚Äëready MVP (Production‚Äëready)

### What Works End‚Äëto‚ÄëEnd

* Phone OTP authentication
* Persistent sessions
* Profile auto‚Äëcreation
* Ride creation wizard (When / Where / Details / Group / Review)
* Join & approval flows
* Owner cancel & participant leave
* Real‚Äëtime participant counts
* Feed with filters and empty states
* Hebrew / English with stable RTL/LTR
* Light / Dark / System themes

### Maps & Location

* Full Mapbox integration (native build)
* Israel Hiking tiles with colored trails
* Full‚Äëscreen map picker
* Correct coordinate persistence
* External navigation (Google Maps / Waze)

### Navigation

* 4 tabs: Feed, My Rides, Create, Profile
* My Rides sections:

  * Organizing
  * Joined
  * Requested

### Production Readiness

* Tested on physical Android devices
* Real OTP flow verified
* Multi‚Äëuser scenarios validated
* Signed APKs ready for distribution

### Known Limitations (Intentional)

* No push notifications yet
* No in‚Äëapp chat
* No ride editing
* No distance sorting

---

## 4. Execution Plan (TODO ‚Äì Forward Looking)

### Priority 1 ‚Äì Engagement Foundation

**Goal:** Prove notification & coordination value

* Test full approval notification flow
* Enforce phone number collection on join
* Personalize feed by home region / ride type

### Priority 2 ‚Äì Social Bridge

**Goal:** Get users into real coordination

* WhatsApp group link per ride
* Edit ride & notify participants

### Priority 3 ‚Äì Refinement

**Goal:** Prepare first 10 testers

* Multi‚Äëdevice testing
* Ride auto‚Äëcleanup (past rides)
* Simplified onboarding (forced home region)

### Explicitly Postponed

* Internal chat (WhatsApp used instead)
* Media uploads
* Ratings / reviews
* "I‚Äôm at the spot" button

---

## Ownership

**Developer:** Eli Eisenstein
**Project:** Bishvil
**Current Focus:** Pilot validation & engagement

---

*End of reshaped documentation*

üèÜ Notification System Milestone Summary
We have successfully implemented a self-healing, event-driven push notification system that connects Supabase database events to physical mobile devices via Expo.

1. Backend & Infrastructure
Trigger-Based Logic: Configured a Supabase Database Webhook that monitors the ride_participants table and automatically triggers a process-ride-event Edge Function whenever a user joins or leaves a ride.

Internal Service Communication: Resolved 401 Unauthorized errors by disabling JWT verification for the send-notification function, allowing secure internal calls using the SERVICE_ROLE_KEY.

Expo API Integration: Authenticated the Edge Function with the Expo Push Service using a dedicated EXPO_ACCESS_TOKEN, confirmed by receiving {"status": "ok"} responses from the Expo API.

2. Mobile App Reliability
Self-Healing Token Sync: Updated App.tsx and notifications.ts to automatically refresh and sync the expo_push_token to the Supabase profiles table every time the app initializes.

Robust Auth Handling: Improved the token update logic to use supabase.auth.getUser() instead of getSession(), ensuring the push token is correctly mapped to the user ID even during "cold starts" or after app reinstalls.

Release-Ready Builds: Successfully deployed and verified the logic using a Release APK (--variant release), ensuring the notification system persists on the device without a development server connection.

3. User Experience & Branding
Custom Notification Channels: Implemented distinct Android Notification Channels (e.g., "Requests & Approvals", "Ride Updates") with specific importance levels and behavior, replacing the generic "Miscellaneous" system group.

Localization Support: Integrated a translation helper (notificationHelpers.ts) that fetches the recipient's preferred language from their profile to deliver notifications in Hebrew or English.

üìù Current Status: STABLE
Verified Flow: User Joins/Leaves ‚Üí DB Trigger ‚Üí Edge Function ‚Üí Expo API ‚Üí Mobile Device (Verified with logs and physical device).

Next Objective: Address UI state refreshing to ensure screens update automatically when a notification is received or an action is performed.
